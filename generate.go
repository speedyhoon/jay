package jay

import (
	"bytes"
	"errors"
	"fmt"
	"mvdan.cc/gofumpt/format"
	"runtime"
	"strings"
)

const DontEditComment = "// Code generated by Jay; DO NOT EDIT."

var ErrNoneExported = errors.New("no exported struct fields found")

func (s *Struct) GenerateFuncs(b *bytes.Buffer) {
	if len(s.fixedLen) == 0 {
		return
	}

	s.MakeMarshalJ(b)
	s.MakeMarshalJTo(b)
	s.MakeSize(b)
	s.MakeUnmarshal(b)
}

func GenerateFile(pkgName string, s []Struct) ([]byte, error) {
	buf := bytes.NewBuffer(nil)
	for i := range s {
		s[i].GenerateFuncs(buf)
	}

	src := buf.Bytes()
	if len(src) == 0 {
		return nil, ErrNoneExported
	}

	if pkgName == "" {
		pkgName = "main"
	}

	src = []byte(fmt.Sprintf(`%s
package %s
import "github.com/speedyhoon/jay"
%s`, DontEditComment, pkgName, src))

	// Nicely format the generated Go code.
	return format.Source(src, format.Options{
		LangVersion: strings.TrimPrefix(runtime.Version(), "go"),
		ExtraRules:  true,
	})
}
